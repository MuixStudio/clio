# Makefile for building with embedded metadata

# ä» service.json è¯»å–å…ƒæ•°æ®
SERVICE_NAME := $(shell cat service.json 2>/dev/null | grep '"name"' | cut -d'"' -f4)
SERVICE_VERSION := $(shell cat service.json 2>/dev/null | grep '"version"' | cut -d'"' -f4)
SERVICE_DESC := $(shell cat service.json 2>/dev/null | grep '"description"' | cut -d'"' -f4)

# å¦‚æœ service.json ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
ifeq ($(SERVICE_NAME),)
    SERVICE_NAME := unknown-service
endif
ifeq ($(SERVICE_VERSION),)
    SERVICE_VERSION := 0.0.0
endif
ifeq ($(SERVICE_DESC),)
    SERVICE_DESC := No description
endif

# æ„å»ºä¿¡æ¯
BUILD_TIME := $(shell date -u '+%Y-%m-%d_%H:%M:%S_UTC')
GIT_COMMIT := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
GIT_BRANCH := $(shell git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
GO_VERSION := $(shell go version | cut -d' ' -f3)

# åŒ…è·¯å¾„ï¼ˆæ ¹æ®ä½ çš„é¡¹ç›®è°ƒæ•´ï¼‰
METADATA_PKG := github.com/muixstudio/clio/services/web/metadata

# ldflags æ„å»ºå‚æ•°
LDFLAGS := -ldflags "\
    -X '$(METADATA_PKG).Name=$(SERVICE_NAME)' \
    -X '$(METADATA_PKG).Version=$(SERVICE_VERSION)' \
    -X '$(METADATA_PKG).Description=$(SERVICE_DESC)' \
    -X '$(METADATA_PKG).BuildTime=$(BUILD_TIME)' \
    -X '$(METADATA_PKG).GitCommit=$(GIT_COMMIT)' \
    -X '$(METADATA_PKG).GitBranch=$(GIT_BRANCH)' \
    -X '$(METADATA_PKG).GoVersion=$(GO_VERSION)'"

# è¾“å‡ºç›®å½•
OUTPUT_DIR := bin
BINARY_NAME := clio

.PHONY: all build build-info clean test help install

# é»˜è®¤ç›®æ ‡
all: build

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
build-info:
	@echo "=== Build Information ==="
	@echo "Service Name:    $(SERVICE_NAME)"
	@echo "Version:         $(SERVICE_VERSION)"
	@echo "Description:     $(SERVICE_DESC)"
	@echo "Build Time:      $(BUILD_TIME)"
	@echo "Git Commit:      $(GIT_COMMIT)"
	@echo "Git Branch:      $(GIT_BRANCH)"
	@echo "Go Version:      $(GO_VERSION)"
	@echo "========================="

# æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
build: build-info
	@echo "ğŸ”¨ Building $(BINARY_NAME)..."
	@mkdir -p $(OUTPUT_DIR)
	go build $(LDFLAGS) -o $(OUTPUT_DIR)/$(BINARY_NAME) ./main.go
	@echo "âœ… Build completed: $(OUTPUT_DIR)/$(BINARY_NAME)"

# æ„å»ºå¹¶è¿è¡Œ
run: build
	@echo "ğŸš€ Running $(BINARY_NAME)..."
	$(OUTPUT_DIR)/$(BINARY_NAME) run

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
version: build
	@$(OUTPUT_DIR)/$(BINARY_NAME) version

# æ¸…ç†æ„å»ºäº§ç‰©
clean:
	@echo "ğŸ§¹ Cleaning..."
	rm -rf $(OUTPUT_DIR)
	@echo "âœ… Cleaned"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª Running tests..."
	go test -v ./...

# å®‰è£…åˆ° GOPATH
install: build-info
	@echo "ğŸ“¦ Installing $(BINARY_NAME)..."
	go install $(LDFLAGS) ./main.go
	@echo "âœ… Installed"

# æ„å»ºå¤šå¹³å°ç‰ˆæœ¬
build-all: build-info
	@echo "ğŸ”¨ Building for multiple platforms..."
	@mkdir -p $(OUTPUT_DIR)
	
	@echo "Building for Linux amd64..."
	GOOS=linux GOARCH=amd64 go build $(LDFLAGS) -o $(OUTPUT_DIR)/$(BINARY_NAME)-linux-amd64 ./main.go
	
	@echo "Building for Linux arm64..."
	GOOS=linux GOARCH=arm64 go build $(LDFLAGS) -o $(OUTPUT_DIR)/$(BINARY_NAME)-linux-arm64 ./main.go
	
	@echo "Building for macOS amd64..."
	GOOS=darwin GOARCH=amd64 go build $(LDFLAGS) -o $(OUTPUT_DIR)/$(BINARY_NAME)-darwin-amd64 ./main.go
	
	@echo "Building for macOS arm64 (M1/M2)..."
	GOOS=darwin GOARCH=arm64 go build $(LDFLAGS) -o $(OUTPUT_DIR)/$(BINARY_NAME)-darwin-arm64 ./main.go
	
	@echo "Building for Windows amd64..."
	GOOS=windows GOARCH=amd64 go build $(LDFLAGS) -o $(OUTPUT_DIR)/$(BINARY_NAME)-windows-amd64.exe ./main.go
	
	@echo "âœ… Multi-platform build completed"
	@ls -lh $(OUTPUT_DIR)

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "Available targets:"
	@echo "  make build       - Build the binary with embedded metadata"
	@echo "  make run         - Build and run the application"
	@echo "  make version     - Build and show version info"
	@echo "  make build-info  - Show build information"
	@echo "  make build-all   - Build for multiple platforms"
	@echo "  make test        - Run tests"
	@echo "  make clean       - Clean build artifacts"
	@echo "  make install     - Install to GOPATH"
	@echo "  make help        - Show this help"